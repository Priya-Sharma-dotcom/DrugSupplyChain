<!DOCTYPE html>
<html>
<head>
    <title>Drug Supply Chain DApp</title>
</head>
<body>
    <h2>Drug Supply Chain DApp</h2>

    <button onclick="connectWallet()">Connect Wallet</button>
    <p id="account"></p>

    <h3>Register Drug</h3>
    <input type="text" id="drugId" placeholder="Drug ID">
    <input type="text" id="name" placeholder="Drug Name">
    <input type="text" id="manufacturer" placeholder="Manufacturer">
    <input type="text" id="location" placeholder="Location">
    <button onclick="registerDrug()">Register</button>

    <h3>Transfer Drug</h3>
    <input type="text" id="transferDrugId" placeholder="Drug ID">
    <input type="text" id="newOwner" placeholder="New Owner Address">
    <button onclick="transferDrug()">Transfer</button>

    <h3>Get Drug Info</h3>
    <input type="text" id="getInfoDrugId" placeholder="Drug ID">
    <button onclick="getDrugInfo()">Get Info</button>
    <pre id="drugInfo"></pre>

    <h3>Get Ownership History</h3>
    <input type="text" id="historyDrugId" placeholder="Drug ID">
    <button onclick="getHistory()">Get History</button>
    <pre id="drugHistory"></pre>

    <h3>Show Total Drug Count</h3>
    <button onclick="showCount()">Show Count</button>
    <p id="drugCount"></p>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
    <script>
        let web3;
        let contract;
        let currentAccount;

        async function connectWallet() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const accounts = await web3.eth.getAccounts();
                currentAccount = accounts[0];
                document.getElementById("account").innerText = "Connected: " + currentAccount;

                const abi = await fetch('abi.json').then(res => res.json());
                const contractAddress = '0x784E1b0168e670F324007c66e96BEdD5aa8Ac1D6';
                contract = new web3.eth.Contract(abi, contractAddress);
            } else {
                alert("MetaMask not detected");
            }
        }

        async function registerDrug() {
            const id = document.getElementById("drugId").value;
            const name = document.getElementById("name").value;
            const manufacturer = document.getElementById("manufacturer").value;
            const location = document.getElementById("location").value;
            try {
                await contract.methods.registerDrug(id, name, manufacturer, location)
                    .send({ from: currentAccount });
                alert("Drug Registered Successfully");
            } catch (err) {
                alert("Failed to register: " + err.message);
            }
        }

        async function transferDrug() {
            const id = document.getElementById("transferDrugId").value;
            const newOwner = document.getElementById("newOwner").value;
            try {
                await contract.methods.transferDrug(id, newOwner).send({ from: currentAccount });
                alert("Drug Transferred");
            } catch (err) {
                alert("Transfer failed: " + err.message);
            }
        }

        async function getDrugInfo() {
            const id = document.getElementById("getInfoDrugId").value;
            try {
                const result = await contract.methods.getDrugInfo(id).call({ from: currentAccount });
                document.getElementById("drugInfo").innerText =
                    `Name: ${result.name}\nManufacturer: ${result.manufacturer}\nCurrent Owner: ${result.currentOwner}\nLocation: ${result.currentLocation}`;
            } catch (err) {
                if (err.message.includes("execution reverted") && err.message.includes("Not an assigned user")) {
                    document.getElementById("drugInfo").innerText = "Access Denied: Not assigned to any role";
                } else {
                    document.getElementById("drugInfo").innerText = "Error: " + err.message;
                }
            }
        }

        async function getHistory() {
            const id = document.getElementById("historyDrugId").value;
            try {
                const history = await contract.methods.getOwnershipHistory(id).call({ from: currentAccount });
                document.getElementById("drugHistory").innerText = history.join('\n');
            } catch (err) {
                if (err.message.includes("execution reverted") && err.message.includes("Not an assigned user")) {
                    document.getElementById("drugHistory").innerText = "Access Denied: Not assigned to any role";
                } else {
                    document.getElementById("drugHistory").innerText = "Error: " + err.message;
                }
            }
        }

        async function showCount() {
            try {
                const count = await contract.methods.getDrugCount().call();
                document.getElementById("drugCount").innerText = "Total Drugs Registered: " + count;
            } catch (err) {
                document.getElementById("drugCount").innerText = "Failed to get drug count: " + err.message;
            }
        }
    </script>
</body>
</html>
